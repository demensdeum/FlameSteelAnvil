 <head>
 </head>
 <body>
    <script>
        initializeWithDatabase = (database, verbose) => {
            debugPrint = (info) => {
                if (verbose) {
                    console.log(info)
                }
            }
            debugPrint(database)
            const none = "<NONE>"
            const doID = () => {
                const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    let result = '';
                    for (let i = 0; i < 16; i++) {
                        result += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                return result;
            }
            let state = {
                "database" : database,
                "project" : none,
                "image" : none,
                "choice" : none,
                "scene" : none
            }
            const listOfProjects = (completion) => {
                let database = state.database
                let transaction = database.transaction("projects", "readwrite")
                let projectsObjectStore = transaction.objectStore("projects")
                let request = projectsObjectStore.openCursor()
                var projects = []
                request.onsuccess = function() {
                    let cursor = request.result
                    if (cursor) {
                        let key = cursor.key
                        let value = cursor.value
                        debugPrint([key, value])
                        projects.push(value)
                        cursor.continue()
                    } else {
                        debugPrint("No more projects")
                        completion(projects)
                    }
                }                
            }
            const createNewProject = () => {
                let transaction = database.transaction("projects", "readwrite")
                let projects = transaction.objectStore("projects")

                let project = {
                    id: doID(),
                }

                let request = projects.add(project)
                request.onsuccess = () => {
                    debugPrint("Project added to the store", request.result)
                    renderState()
                }

                request.onerror = () => {
                    debugPrint("Project added to the store", request.error)
                }                
            }
            const selectProject = (id) => {
                state.project = id
                debugPrint("selectProject: " + id)
            }
            const deleteSelectedProject = () => {
            }
            const uploadImage = (image) => {
            }
            const selectImage = (id) => {
            }
            const removeSelectedImage = () => {
            }
            const addSelectedImageToScene = (position) => {
            }
            const removeSelectedImageFromScene = () => {
            }
            const addChoice = () => {
            }
            const selectChoice = (id) => {
            }
            const deleteSelectedChoice = () => {
            }
            const switchToNextScene = () => {
            }
            const switchToPreviousScene = () => {
            }
            const renderProjectsSection = () => {
                let projectsSection = document.getElementById('projectsSection');
                projectsSection.innerHTML = ''
                
                let newProjectButton = document.createElement("button")
                newProjectButton.textContent = "New Project"
                newProjectButton.onclick = createNewProject
                projectsSection.appendChild(newProjectButton)

                let deleteProjectButton = document.createElement("button")
                deleteProjectButton.textContent = "Delete Project"
                deleteProjectButton.onclick = deleteSelectedProject
                projectsSection.appendChild(deleteProjectButton)

                let br = document.createElement("br")
                projectsSection.appendChild(br)

                listOfProjects((projects) => {
                    debugPrint(projects)
                    let select = document.createElement('select')
                    select.onchange = () => {
                        selectProject(select.value)
                    }
                    if (projects.length > 0) {
                        projects.forEach(e => {
                            let option = document.createElement('option')
                            option.textContent = e.id
                            select.appendChild(option)
                        })
                        projectsSection.appendChild(select)
                    } 
                    else {
                        let p = document.createElement('p')
                        p.textContent = "No projects"
                        projectsSection.appendChild(p)
                    }
                })
            }
            const renderState = (state) => {
                debugPrint("renderState")
                renderProjectsSection()
            }
            renderState(state)
        }
        main = (options) => {
            let databaseOpenRequest = indexedDB.open("database", 1)
            databaseOpenRequest.onupgradeneeded = () => {
                let database = databaseOpenRequest.result
                createOneToOneObjectStore = (database, objectStoreName) => {
                    const store = database.createObjectStore(objectStoreName, { keyPath: "id" })
                    store.createIndex("destination_index", "destination", { unique: false })
                }
                database.createObjectStore("projects", {keyPath: "id"})
                createOneToOneObjectStore(database, "scenes")
                createOneToOneObjectStore(database, "sceneBackgroundImage")
                createOneToOneObjectStore(database, "scenePrimaryImage")
                createOneToOneObjectStore(database, "sceneSecondaryImage")
                createOneToOneObjectStore(database, "sceneTeriaryImage")
                createOneToOneObjectStore(database, "sceneMusic")
                createOneToOneObjectStore(database, "sceneSound")
                createOneToOneObjectStore(database, "primaryChoiceLink")
                createOneToOneObjectStore(database, "secondaryChoiceLink")
                createOneToOneObjectStore(database, "tetriaryChoiceLink")
                createOneToOneObjectStore(database, "translatedStrings")
            }
            databaseOpenRequest.onsuccess = () => {
                let database = databaseOpenRequest.result
                initializeWithDatabase(database, options.verbose)
            }
        }
        main({"verbose" : true})
    </script>
    <div id="projectsSection">Loading list of projects...</div>
 </body>
