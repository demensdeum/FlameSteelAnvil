 <head>
 </head>
 <body>
    <script>
        initializeWithDatabase = (database, verbose) => {
            const debugPrint = (info) => {
                if (verbose) {
                    console.log(info)
                }
            }
            debugPrint(database)
            const none = "<NONE>"
            const doID = () => {
                const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    let result = '';
                    for (let i = 0; i < 16; i++) {
                        result += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                return result;
            }
            let state = {
                "database" : database,
                "project" : none,
                "image" : none,
                "choice" : none,
                "scene" : none
            }
            const listOfProjects = (completion) => {
                let database = state.database
                let transaction = database.transaction("projects", "readwrite")
                let projectsObjectStore = transaction.objectStore("projects")
                let request = projectsObjectStore.openCursor()
                var projects = []
                request.onsuccess = function() {
                    let cursor = request.result
                    if (cursor) {
                        let key = cursor.key
                        let value = cursor.value
                        debugPrint([key, value])
                        projects.push(value)
                        cursor.continue()
                    } else {
                        debugPrint("No more projects")
                        completion(projects)
                    }
                }                
            }
            const createFirstSceneForSelectedProject = () => {
                let transaction = database.transaction("scenes", "readwrite")
                let scenes = transaction.objectStore("scenes")

                const id = `${state.project}-${doID()}`

                let scene = {
                    id: id,
                }

                let request = scenes.add(scene)
                request.onsuccess = () => {
                    state.scene = scene.id
                    debugPrint(`Scene success added: ${id}`)
                }
                request.onerror = () => {
                    debugPrint(`Scene add scene error: ${request.error}`)
                }
            }
            const createNewProject = () => {
                let transaction = database.transaction("projects", "readwrite")
                let projects = transaction.objectStore("projects")

                let project = {
                    id: doID(),
                }

                let request = projects.add(project)
                request.onsuccess = () => {
                    debugPrint(`Project added to the store: ${request.result}`)
                    state.project = project.id
                    createFirstSceneForSelectedProject()
                    renderState()
                }

                request.onerror = () => {
                    debugPrint(`"Project add to the store error: ${request.error}`)
                }                
            }
            const selectProject = (id) => {
                state.project = id
                debugPrint("selectProject: " + id)
            }
            const deleteSelectedProject = () => {
                if (state.project == none) {
                    return
                }
                if (confirm(`Delete project ${state.project}?`)) {
                    let transaction = database.transaction("projects", "readwrite")
                    let projects = transaction.objectStore("projects")
                    let request = projects.delete(state.project)
                    request.onsuccess = () => {
                        debugPrint("Project success delete")
                    }
                    request.onerror = () => {
                        debugPrint(`Project remove from the store error: ${request.error}`)
                    }
                }
            }
            const uploadFile = (file) => {
                if (!file) return
                let transaction = database.transaction("blob", "readwrite")
                let blob = transaction.objectStore("blob")

                let blobID = doID()
                const item = {
                    id: blobID,
                    data: file
                }

                debugPrint(blobID)

                let request = blob.add(item)
                request.onsuccess = () => {
                    debugPrint(`blob uploaded: ${blobID}`)

                    let transaction = database.transaction("backgrounds", "readwrite")
                    let backgrounds = transaction.objectStore("backgrounds")

                    const item = {
                        id: blobID
                    }

                    let request = backgrounds.add(item)
                    request.onsuccess = () => {
                        renderState()
                    }
                    request.onerror = () => {
                        debugPrint(request.error)
                    }
                }
            }
            const selectImage = (id) => {
            }
            const removeSelectedImage = () => {
            }
            const addSelectedImageToScene = (position) => {
            }
            const removeSelectedImageFromScene = () => {
            }
            const addChoice = () => {
            }
            const selectChoice = (id) => {
            }
            const deleteSelectedChoice = () => {
            }
            const switchToNextScene = () => {
            }
            const switchToPreviousScene = () => {
            }
            const renderProjectsSection = () => {
                let projectsSection = document.getElementById('projectsSection');
                projectsSection.innerHTML = ''

                listOfProjects((projects) => {
                    debugPrint(projects)
                    let select = document.createElement('select')
                    select.onchange = () => {
                        selectProject(select.value)
                    }
                    let option = document.createElement('option')
                    option.textContent = none
                    select.appendChild(option)

                    if (projects.length > 0) {
                        projects.forEach(e => {
                            let option = document.createElement('option')
                            option.textContent = e.id
                            select.appendChild(option)
                        })
                        projectsSection.appendChild(select)
                    } 
                    else {
                        let p = document.createElement('p')
                        p.textContent = "No projects"
                        projectsSection.appendChild(p)
                    }

                    let br = document.createElement("br")
                    projectsSection.appendChild(br)

                    let newProjectButton = document.createElement("button")
                    newProjectButton.textContent = "New Project"
                    newProjectButton.onclick = createNewProject
                    projectsSection.appendChild(newProjectButton)

                    let deleteProjectButton = document.createElement("button")
                    deleteProjectButton.textContent = "Delete Project"
                    deleteProjectButton.onclick = deleteSelectedProject
                    projectsSection.appendChild(deleteProjectButton)
                })
            }
            const uploadBackgroundImage = () => {
                debugPrint("uploadBackgroundImage")
            }
            const listOfBackgrounds = (completion) => {
                let database = state.database
                let transaction = database.transaction("backgrounds", "readwrite")
                let backgroundsObjectStore = transaction.objectStore("backgrounds")
                let request = backgroundsObjectStore.openCursor()
                var backgrounds = []
                request.onsuccess = function() {
                    let cursor = request.result
                    if (cursor) {
                        let key = cursor.key
                        let value = cursor.value
                        debugPrint([key, value])
                        backgrounds.push(value)
                        cursor.continue()
                    } else {
                        debugPrint("No more backgrounds")
                        completion(backgrounds)
                    }
                }
            }
            const selectBackground = (background) => {
                sceneBackgroundImage[state.scene] = background
                renderState()
            }
            const renderSceneBackgroundSection = (completion) => {
                let liveEditorSection = document.getElementById('liveEditorSection');
                liveEditorSection.innerHTML = ''

                let database = state.database
                let transaction = database.transaction("sceneBackgroundImage", "readwrite")
                let sceneBackgroundImageObjectStore = transaction.objectStore("sceneBackgroundImage")
                let request = sceneBackgroundImageObjectStore.openCursor()
                request.onsuccess = function() {
                    let cursor = request.result
                    if (cursor) {
                        let key = cursor.key
                        let value = cursor.value
                        debugPrint(`Scene background: ${value}`)
                        let liveEditorSection = document.getElementById('liveEditorSection')
                        let p = document.createElement('p')
                        p.textContent = value.id
                        liveEditorSection.appendChild(p)
                    }
                    else {
                        let p = document.createElement('p')
                        p.textContent = none
                        liveEditorSection.appendChild(p)
                    }

                    let br = document.createElement("br")
                    liveEditorSection.appendChild(br)

                    listOfBackgrounds((backgrounds) => {
                        debugPrint(backgrounds)
                        let select = document.createElement('select')
                        select.onchange = () => {
                            selectBackground(select.value)
                        }
                        let option = document.createElement('option')
                        option.textContent = none
                        select.appendChild(option)

                        if (backgrounds.length > 0) {
                            backgrounds.forEach(e => {
                                let option = document.createElement('option')
                                option.textContent = e.id
                                select.appendChild(option)
                            })
                            liveEditorSection.appendChild(select)
                        }
                        else {
                            let p = document.createElement('p')
                            p.textContent = "No Backgrounds"
                            liveEditorSection.appendChild(p)
                        }

                        let uploadBackgroundImageInput = document.createElement('input')
                        uploadBackgroundImageInput.type = 'file';
                        uploadBackgroundImageInput.accept = 'image/*';
                        uploadBackgroundImageInput.textContent = "Upload Background Image"
                        uploadBackgroundImageInput.onchange = (e) => {
                            let file = e.target.files[0]
                            uploadFile(file);
                        }
                        liveEditorSection.appendChild(uploadBackgroundImageInput)

                        let br = document.createElement("br")
                        liveEditorSection.appendChild(br)

                        completion()
                    })
                }
            }
            const renderSceneTextSection = () => {
                let liveEditorSection = document.getElementById('liveEditorSection');

                let p = document.createElement('input')
                p.textContent = none
                liveEditorSection.appendChild(p)
            }
            const renderLiveEditor = () => {
                let liveEditorSection = document.getElementById('liveEditorSection')
                liveEditorSection.innerHTML = ''

                renderSceneBackgroundSection(() => {
                    renderSceneTextSection(() => {
                        renderScenePrimaryChoiceSection(() => {
                            renderSceneSecondaryChoiceSection(() => {
                                renderSceneTetriaryChoiceSection(() => {
                                    playSceneMusic(() => {
                                        playSceneSound(() => {

                                        })
                                    })
                                })
                            })
                        })
                    })
                })
            }
            const renderState = (state) => {
                debugPrint("renderState")
                renderProjectsSection()
                renderLiveEditor()
            }
            renderState(state)
        }
        main = (options) => {
            let databaseOpenRequest = indexedDB.open("database", 1)
            databaseOpenRequest.onupgradeneeded = () => {
                let database = databaseOpenRequest.result
                createOneToOneObjectStore = (database, objectStoreName) => {
                    const store = database.createObjectStore(objectStoreName, { keyPath: "id" })
                    store.createIndex("destination_index", "destination", { unique: false })
                }
                database.createObjectStore("projects", {keyPath: "id"})
                createOneToOneObjectStore(database, "scenes")
                createOneToOneObjectStore(database, "backgrounds")
                createOneToOneObjectStore(database, "projectFirstScene")
                createOneToOneObjectStore(database, "sceneBackgroundImage")
                createOneToOneObjectStore(database, "scenePrimaryImage")
                createOneToOneObjectStore(database, "sceneSecondaryImage")
                createOneToOneObjectStore(database, "sceneTeriaryImage")
                createOneToOneObjectStore(database, "sceneMusic")
                createOneToOneObjectStore(database, "sceneSound")
                createOneToOneObjectStore(database, "primaryChoiceLink")
                createOneToOneObjectStore(database, "secondaryChoiceLink")
                createOneToOneObjectStore(database, "tetriaryChoiceLink")
                database.createObjectStore("blob", {keyPath: "id"})
                createOneToOneObjectStore(database, "translatedStrings")
            }
            databaseOpenRequest.onsuccess = () => {
                let database = databaseOpenRequest.result
                initializeWithDatabase(database, options.verbose)
            }
        }
        main({"verbose" : true})
    </script>
    <div id="projectsSection">Loading list of projects...</div>
    <div id="liveEditorSection">Loading list of projects...</div>
 </body>
